---
title: 2. AWS RDS Postgres 
description: AWS RDS Postgres
sidebar_position: 2
---

# Amazon RDS PostgreSQL CDC Setup Guide

Amazon RDS for PostgreSQL (non-Aurora) also supports logical replication for CDC. The setup is similar to Aurora, but uses a **DB parameter group** (since RDS instances are single-instance, not cluster-based) and requires the instance to be rebooted after enabling logical decoding.

**Prerequisites:**

- An Amazon RDS for PostgreSQL instance (PostgreSQL 10+).
- A custom **DB parameter group** for this instance (the default parameter group cannot be modified).
- Ability to reboot the RDS instance during a maintenance window or downtime.
- The RDS master user or another user with the `rds_superuser` and `rds_replication` roles.

**Steps:**

1. **Create and Configure a Parameter Group:** In the AWS RDS console, go to *Parameter Groups* and create a new parameter group for your PostgreSQL version (if you don’t already have one). 

![postgres-rds-pg-1](/img/docs/cdc/postgres/postgres-rds-pg-1.png)

Select your database instance and **Associate** the new parameter group with it. Edit the parameters:
   - Set **`rds.logical_replication` = 1**. This enables logical replication (logical decoding) on RDS.
   - This parameter in RDS implicitly requires `wal_level=logical`. On some versions, setting `rds.logical_replication` may automatically set `wal_level=logical` for you, but it’s good to verify or set it explicitly if available.
   - Also, increase `max_replication_slots` and `max_wal_senders` if you plan to have multiple CDC slots or connections concurrently. For example, set them to at least the number of CDC connectors you will run (plus any existing replicas).
   - Save the parameter group changes.

![postgres-rds-pg-2](/img/docs/cdc/postgres/postgres-rds-pg-2.png)

2. **Reboot the RDS Instance:** Reboot the database instance so that the static parameters take effect. After reboot, confirm the settings:
   ```sql
   SELECT name, setting 
   FROM pg_settings 
   WHERE name IN ('rds.logical_replication','wal_level');
   ```
   The query should show `rds.logical_replication` = on, and `wal_level` = logical.

3. **Set Up a Replication User:** The RDS master user automatically has the needed roles (`rds_superuser` which includes logical replication privileges, and `rds_replication`). You can use it for CDC, or create a dedicated user:
   ```sql
   CREATE USER cdc_user WITH PASSWORD 'strongpassword';
   GRANT rds_replication TO cdc_user;
   ```
   RDS does not allow granting full superuser, but granting the `rds_replication` role should allow the user to create and use logical replication slots. (You might also grant `rds_superuser` if RDS allows, but typically only the master user has that privilege. Alternatively, use the master user for simplicity.)

   If using a new user, ensure it has usage rights on the databases/schemas you need. For example:
   ```sql
   GRANT ALL ON SCHEMA public TO cdc_user;
   ```
   This prevents errors like "permission denied for schema" during decoding.

4. **Create a Logical Replication Slot (Optional):** You can let the CDC application create the slot, but to test or manually create one:
   ```sql
   SELECT * 
   FROM pg_create_logical_replication_slot('cdc_slot', 'wal2json');
   ```
   RDS supports the `wal2json` plugin (as well as `test_decoding`) out of the box. This command should succeed if everything is configured. If it fails with an error, check the error:
   - **“must be superuser or replication role to use replication slots”** – the user isn’t permitted (fix by using the master user or granting `rds_replication`).
   - **“logical decoding requires wal_level >= logical”** – the wal_level is not logical (fix by steps 1–2).
   - **Plugin not found** – ensure `rds.logical_replication` is on (which loads wal2json).



5. **Test Decoding (Optional):** As a quick test, you can generate a change and read from the slot:
   ```sql
   INSERT INTO test_table(val) VALUES('rds cdc test');
   SELECT data FROM pg_logical_slot_get_changes('cdc_slot', NULL, NULL, 'pretty-print', '1');
   ```
   You should see a JSON change record from wal2json. This confirms CDC is capturing changes.

6. **Connect Your CDC Connector:** Use the RDS endpoint, database name, and the replication user (`cdc_user` or master) in your OLake configuration. Specify the plugin as `wal2json`. The connector will stream changes via the logical slot.

   Make sure the network setup allows the connector to reach the RDS instance (RDS must be publicly accessible or your connector is in the same VPC/network).

**Troubleshooting:**

- **Parameter Group Not Applying:** If `rds.logical_replication` remains off after reboot, check that:
  - The instance is actually using your custom parameter group (in the RDS console, on the **Configuration** tab, verify the parameter group name).
  - The parameter group family matches your engine version (e.g., “postgres12”). If not, some parameters might be ignored.
  - You saved the changes and rebooted. Static parameters won’t apply without a reboot.

- **Access Issues:** If the OLake reports `ERROR: permission denied for relation/sequence ...` or *"permission denied for schema"* during snapshot or streaming, the replication user might lack SELECT privileges on those tables/schemas. Logical decoding itself does not check table ACLs for emitting changes. Grant the necessary privileges or use the master user for the initial snapshot. Also, ensure the user has the `rds_replication` role to use the slot.

- **Slot or Plugin Errors:** 
  - If creating a slot yields `ERROR: permission denied to create replication slot`, use the master user or a user with `rds_superuser` role to create it.
  - If you see `ERROR: logical decoding requires wal_level "logical"`, it means wal_level is not logical – double-check the parameter group (maybe the DB is still running with the old param group).
  - If the error is about `wal2json` not found, ensure `rds.logical_replication` is enabled, as that is required to load wal2json on RDS.

- **WAL buildup / Disk Full:** Similar to Aurora, an inactive logical slot on RDS will prevent WAL files from being purged. Monitor the **WAL storage** on RDS (CloudWatch metric "TransactionLogsDiskUsage"). If your CDC connector falls behind or is stopped for a while, the disk usage can grow. In extreme cases, you might get RDS events complaining that “The transaction logs have consumed XX% of storage”. To fix, either restart the CDC process to consume the backlog or drop the slot if you no longer need it. For example:
  ```sql
  SELECT pg_drop_replication_slot('cdc_slot');
  ```
  Do this **only** if you are okay with re-snapshotting, as dropping the slot means you’ll lose the record of changes.

- **Replication Role Setup:** On RDS, you cannot simply do `ALTER ROLE ... WITH REPLICATION` (superuser required). Instead, AWS uses the predefined roles. The master user automatically has `rds_superuser` and `rds_replication`. If you create a new user, you can grant `rds_replication` to it. If that grant fails, it may require you to be master user (try as master). If using the master user for CDC, no action needed. In summary, many users choose the master user for CDC on RDS to avoid role issues.

- **Network and Connectivity:** Ensure your RDS instance is reachable:
  - If it’s in a private subnet, your CDC application must have network access (consider running the CDC connector on an EC2 in the same VPC).
  - If it’s publicly accessible, open the security group to the connector's IP (or corporate network) on port 5432. 
  - RDS may enforce SSL; use the SSL connection if required (check the parameter `rds.force_ssl`).

- **Schema Changes:** If the schema changes (DDL statements), wal2json will emit them in the WAL (as DDL is logged), but your connector needs to handle schema refresh accordingly. 

By following these steps, CDC should be active on your RDS PostgreSQL instance, streaming changes through wal2json.