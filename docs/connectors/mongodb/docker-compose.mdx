---
title: Setup MongoDB via Docker Compose
description: Setup MongoDB via Docker Compose
sidebar_position: 3
---

# To spawn mongo replica set for unit tests

Use the [/feat/test_framework](https://github.com/datazip-inc/olake/tree/feat/test_framework) branch for the following setup.

Clone the branch using:

```bash
git clone -b feat/test_framework https://github.com/datazip-inc/olake.git
```
and then pull the latest changes using:

```bash
git pull origin feat/test_framework
```

If you already have `master` olake branch, perform the following steps:

```bash
git fetch --all # Fetch all the remote branches
git branch -r   # Verify that feat/test_framework exists in the remote repo, press `q` to quit.
git checkout -b feat/test_framework origin/feat/test_framework # This creates a local branch named feat/test_framework and tracks the remote branch origin/feat/test_framework.
git branch # You should see feat/test_framework as the active branch (* feat/test_framework).
git pull origin feat/test_framework # [optional] To ensure your local branch is up-to-date
```

### `docker-compose.yaml`

```yaml title="drivers/mongodb/docker-compose.yaml"
# To spawn mongo replica set for unit tests
version: "3.7"

services:
  db:
    image: 'mongo:latest'
    environment: {"MONGO_INITDB_ROOT_USERNAME": "olake", "MONGO_INITDB_ROOT_PASSWORD": "olake"}
    command: "mongod --bind_ip_all --replSet rs0 --keyFile /etc/ssl/sample.key"
    entrypoint: ["bash", "-c", "chmod 400 /etc/ssl/sample.key; chown 999:999 /etc/ssl/sample.key; exec docker-entrypoint.sh $@"]
    ports:
      - "27017:27017"
    networks:
      - olake-test
    volumes:
      - ${PWD}/drivers/mongodb/test.key:/etc/ssl/sample.key
    healthcheck:
      test: ["CMD","mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 5s
      timeout: 5s
      retries: 3
      start_period: 5s

networks:
  olake-test:
    name: olake-test
    external: true
```

### `docker-compose-init.sh`
```sh title="drivers/mongodb/docker-compose-init.sh
function mongosh() {
	echo "$@" | docker exec -i mongodb-db-1 mongosh -u olake -p olake admin
}

mongosh 'rs.initiate()'
sleep 3
mongosh 'cfg = rs.conf(); cfg.members[0].host="localhost:27017"; rs.reconfig(cfg);'
```

- This function **runs MongoDB shell (`mongosh`) commands inside the Docker container**.  
- It executes commands on the `mongodb-db-1` container using `docker exec`.  
- The `-u olake -p olake admin` flags mean it connects to the **MongoDB admin database** using the username `olake` and password `olake`.
- `mongosh 'rs.initiate()'` - **initializes a new MongoDB replica set**.  
- A replica set allows MongoDB to support **failover and high availability**.  
- By default, `rs.initiate()` configures the instance as a **single-node replica set**.
- `sleep 3` - This **pauses execution for 3 seconds** to ensure MongoDB completes the initialization before reconfiguring the replica set.
- **`rs.conf()`** → Fetches the current replica set configuration.  
- **`cfg.members[0].host="localhost:27017"`** → Updates the hostname of the first (and only) replica set member to `localhost:27017`.  
- **`rs.reconfig(cfg)`** → Applies the new replica set configuration.  

After running the script, your MongoDB instance inside Docker:
✅ **Becomes a single-node replica set**  
✅ **Uses "localhost:27017" as its hostname**  
✅ **Is ready for connections as a replica set-enabled database**  


### How to Run MongoDB Unit Tests 
To run Mongo Unit tests, start the docker compose and initiate it:

Create Network `olake-test`:
```bash
docker network create olake-test    
```

Sample output:
```bash
docker network create olake-test
ef0000000x0x0253141909abff6744fcf4c26d8f0e56865cc364690a97289b0f

```
Run docker container:
```bash
docker compose -f ./drivers/mongodb/docker-compose.yaml up -d  
```
![docker compose 1](/img/docs/docker/docker-compose-1.png)

```bash
bash ./drivers/mongodb/docker-compose-init.sh  
```

![docker compose 2](/img/docs/docker/docker-compose-2.png)
![docker compose 3](/img/docs/docker/docker-compose-3.png)

Then you can run mongo tests:
```bash
go test -tags -v ./drivers/mongodb/internal                  
```

Stop the mongodb instance:
```bash
docker compose -f ./drivers/mongodb/docker-compose.yaml down
```

Now your source configuration becomes:

```json title="config.json"
{
  "hosts": ["localhost:27017"],
  "username": "olake",
  "password": "olake",
  "authdb": "admin",
  "replica-set": "rs0",
  "read-preference": "secondaryPreferred",
  "srv": false,
  "server-ram": 16,
  "database": "reddit",
  "max_threads": 50,
  "default_mode": "cdc",
  "backoff_retry_count": 2
}
```

## Exec into the replica set and see dbs
Use the following command:
```bash
docker exec -it mongodb-db-1 mongosh -u olake -p olake --eval "show dbs"
```

Remove `--eval "show dbs"` if you just want to exec into the container.

You would see something like:
```bash
Current Mongosh Log ID:	67b701a825ed4f7925a00aa0
Connecting to:		mongodb://<credentials>@127.0.0.1:27017/?directConnection=true&serverSelectionTimeoutMS=2000&appName=mongosh+2.3.8
Using MongoDB:		8.0.4
Using Mongosh:		2.3.8

For mongosh info see: https://www.mongodb.com/docs/mongodb-shell/

rs0 [direct: primary] test> show dbs;
admin   140.00 KiB
config   80.00 KiB
local   436.00 KiB
```


### How to Ingest JSON Data into MongoDB (From URL or Local File)

## ✅ **Ingest JSON Directly from the an API**  
We have provided some [sample datasets](../../resources/dataset) for you to test OLake. You can fetch the JSON from the URL and insert it into MongoDB **without saving it as a file**:  

### **Run This One-Liner in Your Terminal**  
```sh
curl -s "https://www.reddit.com/r/funny.json" | \
jq '.data.children | map(.data)' | \
docker exec -i mongodb-db-1 mongoimport -u olake -p olake --authenticationDatabase admin --db reddit --collection funny --jsonArray
```

### **What This Does?**  
- `curl -s "https://www.reddit.com/r/funny.json"` → Fetches the Reddit JSON data.  
- `jq '.data.children | map(.data)'` → Extracts only the `children` array and keeps only the `data` field.
- `docker exec -i mongodb-db-1 mongoimport ...` → Runs `mongoimport` inside the container.  
- `--db reddit` → Inserts data into the **`reddit`** database.  
- `--authenticationDatabase admin` → Ensures authentication happens in the admin database.
- `--collection funny` → Stores the data in the **`funny`** collection.  
- `--jsonArray` → Assumes the JSON is an **array of objects** (useful if the API returns one).  


## ✅ **Verify the Data in MongoDB**
After importing, check if the data is inside MongoDB:  

### **Exec into the MongoDB Shell**
```sh
docker exec -it mongodb-db-1 mongosh -u olake -p olake
```

### **Switch to the Database**
```js
use reddit
```

### **Check the Collection**
```js
db.funny.find().limit(5).pretty()
```

This will show a **formatted output** of the first 5 documents.

You can then proceed to [getting started guide](../../getting-started) to setup OLake.

Below are sample commands you can use:

### 1. Discover

```

```