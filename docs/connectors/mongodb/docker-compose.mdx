---
title: Setup Replica Set
description: Setup MongoDB via Docker Compose
sidebar_position: 3
---

# Setup MongoDB Replica Set via Docker Compose
This guide explains how to spawn a MongoDB replica set using Docker Compose for unit tests. It also covers instructions for ingesting sample data, and verifying the setup.


:::info
Clone the OLake repository if you want to build OLake locally, or skip to the part to use Dockerized OLake.

GitHub repository
```sh
git clone git@github.com:datazip-inc/olake.git
```
:::


Navigate to `./drivers/mongodb/config` (if building locally) OR just create a directory (say `olake-docker`) anywhere in your system if you want to use Dockerzied OLake and create these files:
1. `docker-compose.yaml`
2. `config.json`
3. `writer.json` -> Refer the [additional-references](#additional-references) for details on writer file config.


<Tabs>

<TabItem value="docker" label="Using Dockerized OLake" default>

## 1. `docker-compose.yaml`


```yaml title="docker-compose.yaml"
services:
  init-keyfile:
    image: mongo:8.0
    container_name: init_keyfile
    command: >
      sh -c "
      if [ ! -f /etc/mongodb/pki/keyfile ]; then
        echo 'Generating keyfile...';
        openssl rand -base64 756 > /etc/mongodb/pki/keyfile && chmod 400 /etc/mongodb/pki/keyfile;
      else
        echo 'Keyfile already exists.';
      fi
      "
    volumes:
      - mongo-keyfile-vol:/etc/mongodb/pki
    networks:
      - mongo-cluster
    restart: "no"

  primary:
    container_name: primary
    image: mongo:8.0
    hostname: primary
    ports:
      - "27017:27017"
    depends_on:
      - init-keyfile
    volumes:
      - mongo-data:/data/db
      - mongo-keyfile-vol:/etc/mongodb/pki
    command: |
      bash -c '
      echo "Waiting for keyfile..."
      while [ ! -f /etc/mongodb/pki/keyfile ]; do sleep 1; done
      
      echo "Keyfile found, starting mongod without authentication first..."
      mongod --replSet rs0 --bind_ip_all --port 27017 &
      
      # Store the PID of mongod
      MONGO_PID=$!
      
      # Wait for MongoDB to start
      echo "Waiting for MongoDB to start..."
      until mongosh --port 27017 --eval "db.runCommand({ ping: 1 })" >/dev/null 2>&1; do
        sleep 2
      done
      
      # Initialize replica set
      echo "Initializing replica set..."
      mongosh --port 27017 --eval "rs.initiate({_id: \"rs0\", members: [{_id: 0, host: \"host.docker.internal:27017\"}]})"
      
      # Wait for replica set to initialize
      echo "Waiting for replica set to initialize..."
      sleep 5
      
      # Create admin user
      echo "Creating admin user..."
      mongosh --port 27017 --eval "
        db = db.getSiblingDB(\"admin\");
        db.createUser({
          user: \"admin\",
          pwd: \"password\",
          roles: [{ role: \"root\", db: \"admin\" }]
        });
      "
    
      # Stop the MongoDB instance
      echo "Stopping MongoDB to restart with authentication..."
      kill $MONGO_PID
      wait $MONGO_PID
      
      # Start MongoDB with authentication
      echo "Starting MongoDB with authentication..."
      exec mongod --replSet rs0 --bind_ip_all --port 27017 --keyFile /etc/mongodb/pki/keyfile
      '
    healthcheck:
      test: ["CMD", "mongosh", "--port", "27017", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 10s
      retries: 10
    networks:
      - mongo-cluster

  data-loader:
    image: mongo:8.0
    container_name: sample_data_loader
    depends_on:
      primary:
        condition: service_healthy
    entrypoint: |
      bash -c '
      echo "Waiting for MongoDB admin user to be ready..."
      until mongosh --host primary --username "admin" --password "password" --authenticationDatabase admin --eval "db.runCommand({ ping: 1 })" >/dev/null 2>&1; do
        echo "Waiting for admin authentication to be ready..."
        sleep 2
      done
      
      apt-get update && apt-get install -y curl wget jq
      
      echo "Downloading Sample Reddit data..."
      curl -s "https://raw.githubusercontent.com/datazip-inc/olake-docs/refs/heads/master/static/reddit.json" >> /tmp/reddit.json
      
      echo "Importing Sample Reddit data into the reddit database, funny collection..."
      mongoimport --host primary --username "admin" --password "password" --authenticationDatabase admin --db reddit --collection funny --file /tmp/reddit.json --jsonArray
      
      echo "Sample Reddit data import complete!"
      '
    restart: "no"
    networks:
      - mongo-cluster

networks:
  mongo-cluster:

volumes:
  mongo-keyfile-vol:
  mongo-data:
```



## 2. OLake Integration

After verifying MongoDB’s configuration, proceed with OLake’s integration steps. Refer to the [getting started guide](../../getting-started) for more details.


Update your source configuration file (`config.json`) to connect to MongoDB as follows:

```json title="config.json"
{
  "hosts": ["host.docker.internal:27017"],
  "username": "admin",
  "password": "password",
  "authdb": "admin",
  "replica-set": "rs0",
  "read-preference": "secondaryPreferred",
  "srv": false,
  "server-ram": 16,
  "database": "reddit",
  "max_threads": 50,
  "default_mode": "cdc",
  "backoff_retry_count": 2
}
```


## 3. Starting MongoDB

To start the MongoDB container, run the following command from your project directory:

```bash
docker compose up -d
```

## 4. Start replicating you Data

:::info
Run `docker network ls` to get a list of all networks being created. By default Compose sets up a single network for your app. Change the `--network=<your_network_name>` in the commands below. Usually a default network is created of the syntax `YOUR_DIRECTORY_NAME_default`
:::

### 4.1. Discover Collection Schema

<Tabs groupId="docker">
<TabItem value="macos-linux" label="macOS / Linux" default>

```bash
docker run \
  -v "$HOME/Desktop/projects/olake-docker:/mnt/config" \
  olakego/source-mongodb:latest \
  discover \
  --config /mnt/config/config.json
```

</TabItem>

<TabItem value="cmd" label="CMD">

```bash
docker run ^
  -v "%USERPROFILE%\Desktop\projects\olake-docker:/mnt/config" ^
  olakego/source-mongodb:latest ^
  discover ^
  --config /mnt/config/config.json
```

</TabItem>


<TabItem value="powershell" label="Powershell">

```bash
docker run `
  -v "$env:USERPROFILE\Desktop\projects\olake-docker:/mnt/config" `
  olakego/source-mongodb:latest `
  discover `
  --config /mnt/config/config.json
```

</TabItem>


</Tabs>

### 4.2. Sync Data
<Tabs groupId="docker">

<TabItem value="macos-linux" label="macOS / Linux" default>

```bash
docker run \
  -v "$HOME/Desktop/projects/olake-docker:/mnt/config" \
  olakego/source-mongodb:latest \
  sync \
  --config /mnt/config/config.json \
  --catalog /mnt/config/catalog.json \
  --destination /mnt/config/writer.json
```
</TabItem>

<TabItem value="cmd" label="CMD">

```bash
docker run ^
  -v "%USERPROFILE%\Desktop\projects\olake-docker:/mnt/config" ^
  olakego/source-mongodb:latest ^
  sync ^
  --config /mnt/config/config.json ^
  --catalog /mnt/config/catalog.json ^
  --destination /mnt/config/writer.json
```
</TabItem>

<TabItem value="powershell" label="Powershell">

```bash
docker run `
  -v "$env:USERPROFILE\Desktop\projects\olake-docker:/mnt/config" `
  olakego/source-mongodb:latest `
  sync `
  --config /mnt/config/config.json `
  --catalog /mnt/config/catalog.json `
  --destination /mnt/config/writer.json
```

</TabItem>
</Tabs>

Sample output syncing our sample reddit data and writing locally in parquet format:

![docker compose 4](/img/docs/docker/docker-compose-4.png)


### 4.3. Sync with state

<Tabs groupId="docker">

<TabItem value="macos-linux" label="macOS / Linux" default>

```bash 
docker run \
  -v /Users/user_name/Desktop/projects/olake-docker:/mnt/config \
  olakego/source-mongodb:latest \
  sync \
  --config /mnt/config/config.json \
  --catalog /mnt/config/catalog.json \
  --destination /mnt/config/writer.json \
  --state /mnt/config/state.json
```

</TabItem>

<TabItem value="cmd" label="CMD">

```bash 
docker run ^
  -v "%USERPROFILE%\Desktop\projects\olake-docker:/mnt/config" ^
  olakego/source-mongodb:latest ^
  sync ^
  --config /mnt/config/config.json ^
  --catalog /mnt/config/catalog.json ^
  --destination /mnt/config/writer.json ^
  --state /mnt/config/state.json
```


</TabItem>


<TabItem value="powershell" label="Powershell">

```bash 
docker run `
  -v "$env:USERPROFILE\Desktop\projects\olake-docker:/mnt/config" `
  olakego/source-mongodb:latest `
  sync `
  --config /mnt/config/config.json `
  --catalog /mnt/config/catalog.json `
  --destination /mnt/config/writer.json `
  --state /mnt/config/state.json
```

</TabItem>
</Tabs>



</TabItem>



<TabItem value="build" label="Using Local build OLake" default>


## 1. `docker-compose.yaml`


```yaml title="docker-compose.yaml"
services:
  init-keyfile:
    image: mongo:8.0
    container_name: init_keyfile
    command: >
      sh -c "
      if [ ! -f /etc/mongodb/pki/keyfile ]; then
        echo 'Generating keyfile...';
        openssl rand -base64 756 > /etc/mongodb/pki/keyfile && chmod 400 /etc/mongodb/pki/keyfile;
      else
        echo 'Keyfile already exists.';
      fi
      "
    volumes:
      - mongo-keyfile-vol:/etc/mongodb/pki
    networks:
      - mongo-cluster
    restart: "no"

  primary:
    container_name: primary
    image: mongo:8.0
    hostname: primary
    ports:
      - "27017:27017"
    depends_on:
      - init-keyfile
    volumes:
      - mongo-data:/data/db
      - mongo-keyfile-vol:/etc/mongodb/pki
    command: |
      bash -c '
      echo "Waiting for keyfile..."
      while [ ! -f /etc/mongodb/pki/keyfile ]; do sleep 1; done
      
      echo "Keyfile found, starting mongod without authentication first..."
      mongod --replSet rs0 --bind_ip_all --port 27017 &
      
      # Store the PID of mongod
      MONGO_PID=$!
      
      # Wait for MongoDB to start
      echo "Waiting for MongoDB to start..."
      until mongosh --port 27017 --eval "db.runCommand({ ping: 1 })" >/dev/null 2>&1; do
        sleep 2
      done
      
      # Initialize replica set
      echo "Initializing replica set..."
      mongosh --port 27017 --eval "rs.initiate({_id: \"rs0\", members: [{_id: 0, host: \"localhost:27017\"}]})"
      
      # Wait for replica set to initialize
      echo "Waiting for replica set to initialize..."
      sleep 5
      
      # Create admin user
      echo "Creating admin user..."
      mongosh --port 27017 --eval "
        db = db.getSiblingDB(\"admin\");
        db.createUser({
          user: \"admin\",
          pwd: \"password\",
          roles: [{ role: \"root\", db: \"admin\" }]
        });
      "
    
      # Stop the MongoDB instance
      echo "Stopping MongoDB to restart with authentication..."
      kill $MONGO_PID
      wait $MONGO_PID
      
      # Start MongoDB with authentication
      echo "Starting MongoDB with authentication..."
      exec mongod --replSet rs0 --bind_ip_all --port 27017 --keyFile /etc/mongodb/pki/keyfile
      '
    healthcheck:
      test: ["CMD", "mongosh", "--port", "27017", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 10s
      retries: 10
    networks:
      - mongo-cluster

  data-loader:
    image: mongo:8.0
    container_name: sample_data_loader
    depends_on:
      primary:
        condition: service_healthy
    entrypoint: |
      bash -c '
      echo "Waiting for MongoDB admin user to be ready..."
      until mongosh --host primary --username "admin" --password "password" --authenticationDatabase admin --eval "db.runCommand({ ping: 1 })" >/dev/null 2>&1; do
        echo "Waiting for admin authentication to be ready..."
        sleep 2
      done
      
      apt-get update && apt-get install -y curl wget jq
      
      echo "Downloading Sample Reddit data..."
      curl -s "https://raw.githubusercontent.com/datazip-inc/olake-docs/refs/heads/master/static/reddit.json" >> /tmp/reddit.json
      
      echo "Importing Sample Reddit data into the reddit database, funny collection..."
      mongoimport --host primary --username "admin" --password "password" --authenticationDatabase admin --db reddit --collection funny --file /tmp/reddit.json --jsonArray
      
      echo "Sample Reddit data import complete!"
      '
    restart: "no"
    networks:
      - mongo-cluster

networks:
  mongo-cluster:

volumes:
  mongo-keyfile-vol:
  mongo-data:
```


## 2. OLake Integration

After verifying MongoDB’s configuration, proceed with OLake’s integration steps. Refer to the [getting started guide](../../getting-started) for more details.


Update your source configuration file (`config.json`) to connect to MongoDB as follows:

```json title="config.json"
{
  "hosts": ["localhost:27017"],
  "username": "admin",
  "password": "password",
  "authdb": "admin",
  "replica-set": "rs0",
  "read-preference": "secondaryPreferred",
  "srv": false,
  "server-ram": 16,
  "database": "reddit",
  "max_threads": 50,
  "default_mode": "cdc",
  "backoff_retry_count": 2
}
```

## 3. Starting MongoDB

To start the MongoDB container, run the following command from your project directory:

```bash
docker compose -f ./drivers/mongodb/config/docker-compose.yaml up -d
```

## 4. Start replicating you Data

### 4.1. Discover Collection Schema
<Tabs groupId="build-locally">

<TabItem value="macos-linux" label="macOS / Linux" default>

```bash
OLAKE_BASE_PATH="$HOME/Desktop/projects/olake/drivers/mongodb/config" && \
./build.sh driver-mongodb discover \
  --config "$OLAKE_BASE_PATH/config.json"
```

</TabItem> 

<TabItem value="cmd" label="CMD">

```bash
set "OLAKE_BASE_PATH=%USERPROFILE%\Desktop\projects\olake\drivers\mongodb\config" && ^
./build.sh driver-mongodb discover ^
  --config "%OLAKE_BASE_PATH%\config.json"
```
</TabItem> 

<TabItem value="powershell" label="Powershell">

```bash
$OLAKE_BASE_PATH = "$env:USERPROFILE\Desktop\projects\olake\drivers\mongodb\config"; `
./build.sh driver-mongodb discover `
  --config "$OLAKE_BASE_PATH\config.json"
```

</TabItem> 
</Tabs>

### 4.2. Sync Data Command

<Tabs groupId="build-locally">

<TabItem value="macos-linux" label="macOS / Linux" default>

```bash
OLAKE_BASE_PATH="$HOME/Desktop/projects/olake/drivers/mongodb/config" && \
./build.sh driver-mongodb sync \
  --config "$OLAKE_BASE_PATH/config.json" \
  --catalog "$OLAKE_BASE_PATH/catalog.json" \
  --destination "$OLAKE_BASE_PATH/writer.json"
```

</TabItem> 

<TabItem value="cmd" label="CMD">

```bash
set "OLAKE_BASE_PATH=%USERPROFILE%\Desktop\projects\olake\drivers\mongodb\config" && ^
./build.sh driver-mongodb sync ^
  --config "%OLAKE_BASE_PATH%\config.json" ^
  --catalog "%OLAKE_BASE_PATH%\catalog.json" ^
  --destination "%OLAKE_BASE_PATH%\writer.json"
```

</TabItem> 

<TabItem value="powershell" label="Powershell">

```bash
$OLAKE_BASE_PATH = "$env:USERPROFILE\Desktop\projects\olake\drivers\mongodb\config"; `
./build.sh driver-mongodb sync `
  --config "$OLAKE_BASE_PATH\config.json" `
  --catalog "$OLAKE_BASE_PATH\catalog.json" `
  --destination "$OLAKE_BASE_PATH\writer.json"
```
</TabItem> 

</Tabs>

Sample output syncing our sample reddit data and writing locally in parquet format:

![docker compose 4](/img/docs/docker/docker-compose-4.png)


### 4.3. Sync with State

<Tabs groupId="build-locally">

<TabItem value="macos-linux" label="macOS / Linux" default>

```bash
OLAKE_BASE_PATH="$HOME/Desktop/projects/olake/drivers/mongodb/config" && \
./build.sh driver-mongodb sync \
  --config "$OLAKE_BASE_PATH/config.json" \
  --catalog "$OLAKE_BASE_PATH/catalog.json" \
  --destination "$OLAKE_BASE_PATH/writer.json" \
  --state "$OLAKE_BASE_PATH/state.json"
```

</TabItem> 

<TabItem value="cmd" label="CMD">

```bash
set "OLAKE_BASE_PATH=%USERPROFILE%\Desktop\projects\olake\drivers\mongodb\config" && ^
./build.sh driver-mongodb sync ^
  --config "%OLAKE_BASE_PATH%\config.json" ^
  --catalog "%OLAKE_BASE_PATH%\catalog.json" ^
  --destination "%OLAKE_BASE_PATH%\writer.json" ^
  --state "%OLAKE_BASE_PATH%\state.json"
```

</TabItem> 

<TabItem value="powershell" label="Powershell">

```bash
$OLAKE_BASE_PATH = "$env:USERPROFILE\Desktop\projects\olake\drivers\mongodb\config"; `
./build.sh driver-mongodb sync `
  --config "$OLAKE_BASE_PATH\config.json" `
  --catalog "$OLAKE_BASE_PATH\catalog.json" `
  --destination "$OLAKE_BASE_PATH\writer.json" `
  --state "$OLAKE_BASE_PATH\state.json"
```
</TabItem> 

</Tabs>

</TabItem>
</Tabs>


## Additional References

- **Configuration Files:**  
  Refer to the following documentation for configuration details:
  1. [`config.json`](../../configs/source)
  2. [`catalog.json`](../../configs/catalog)
  3. [`writer.json`](../../configs/writer)
  4. [`state.json`](../../configs/state)

- **Viewing Parquet Files:**  
  Use the [VS Code extension - Parquet Explorer](https://marketplace.visualstudio.com/items?itemName=AdamViola.parquet-explorer) to view Parquet files in your editor.


## Troubleshooting

If you encounter any issues, consider the following:

- **Container Logs:**  
  Check container logs for MongoDB using:
  
  ```bash
  docker logs CONTAINER_ID
  ```
