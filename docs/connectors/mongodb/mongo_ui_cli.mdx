import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import StreamsConfiguration from '../../shared/streams/StreamsConfiguration.mdx';

# MongoDB Source Documentation

<Tabs>

  <TabItem value="ui" label="OLake UI" default>

## Setup Prerequisites

Before beginning, ensure the following are installed and running:

- Docker and Docker Compose (latest version)
- MongoDB instance (local or remote) with credentials ready to act as source

### Additional Note: CDC Requirements for MongoDB
If you want Olake to continuously capture new changes (CDC mode), MongoDB must:
- Be started in replica set mode (`--replSet rs0`).
- Have oplog enabled (automatic in replica sets).
- Have a user with both:
  - `readWrite` role on your database, and
  - `read` role on the local database (to read oplog).

**To set up MongoDB for CDC, please refer to the [MongoDB CDC Setup](./cdc_setup) guide.**

---

## Configuration

### Create MongoDB Source Setup via Olake UI

Once the Olake UI setup is finished these steps can be followed:

1. Open Olake Web Console → [https://localhost:8000](https://localhost:8000)
2. Login with `Username: admin` / `Password: password`
3. Go to **Sources → + Create Source**.
4. Select **MongoDB** from the list.
5. Fill connection details.
6. Save changes.

The following image shows the Olake UI configuration screen. Use it as a reference to provide MongoDB connection details when creating the source:

![Olake UI MongoDB Source Setup](/img/connectors/mongodb/mongodb-ui-setup.png)

**Description of above parameters:**

| Field | Description | Example Value | Data Type |
|-------|-------------|---------------|-----------|
| `hosts` | List of MongoDB hosts. Use DNS SRV if `srv = true`. | `x.xxx.xxx.120:27017`, `x.xxx.xxx.120:27017`, `x.xxx.xxx.133:27017` (can be multiple) | STRING[] |
| `username`/`password` | Credentials for MongoDB authentication. | `"test"`/`"test"` | STRING |
| `authdb` | Authentication database (often `admin`). | `"admin"` | STRING |
| `replica_set` | Name of the replica set, if applicable. | `"rs0"` | STRING |
| `read_preference` | Which node to read from (e.g., `secondaryPreferred`). | `"secondaryPreferred"` | STRING |
| `srv` | If using DNS SRV connection strings, set to `true`. When `true`, there can only be 1 host in `hosts` field. | If `true`, the `hosts` key will have a value something like `["mongodatatest.pigiy.mongodb.net"]` | `true`, `false` | BOOL |
| `database` | The MongoDB database name to replicate. | `"database_name"` | STRING |
| `max_threads` | Maximum parallel threads for chunk-based snapshotting. | `5` | INT |
| `backoff_retry_count` | Retries attempt to establish sync again if it fails, increases exponentially (in minutes - 1, 2, 4, 8, 16... depending upon the `backoff_retry_count` value) | defaults to 3, takes default value if set to -1 | INT |
| `chunking_strategy` | The chunking strategy used for backfill. <br/>- `timestamp`: Splits data based on time fields.<br/>- `bucket_auto`: Uses MongoDB’s `$bucketAuto` for automatic bucketing.<br/>- `splitVector`: Uses the built-in `splitVector` command. <br/>If left empty, defaults to `splitVector`. <br/>Refer [here](../../../blog/2025-05-07-what-makes-olake-fast#mongodb) for more details. | `"timestamp"` / `"bucket_auto"` / `"splitVector"` | STRING |


  </TabItem>

  <TabItem value="cli" label="OLake CLI">

## Setup Prerequisites

Before beginning, ensure the following are installed and running:

- Docker and Docker Compose (latest version)
- MongoDB instance (local or remote) with credentials ready to act as source
- Olake Docker Image: `olakego/source-mongodb:latest`

### Additional Note: CDC Requirements for MongoDB
If you want Olake to continuously capture new changes (CDC mode), MongoDB must:
- Be started in replica set mode (`--replSet rs0`).
- Have oplog enabled (automatic in replica sets).
- Have a user with both:
  - `readWrite` role on your database, and
  - `read` role on the local database (to read oplog).

**To set up MongoDB for CDC, please refer to the [MongoDB CDC Setup](./cdc_setup) guide.**

---

## Configuration

### MongoDB Source Setup via Olake CLI

#### 1) Create config directory

Create a folder (directory) where we will store `source.json` so everything is organised.

You can create this directory in two ways:

**Option 1:** You can manually create a folder.

**Option 2:**

```bash
mkdir olake-mongodb
cd olake-mongodb
```

#### 2) Create a file named `source.json` with MongoDB connection details

**Example:**

```json
{
  "hosts": ["host1:27017", "host2:27017", "host3:27017"],
  "username": "your_username",
  "password": "your_password",
  "authdb": "admin",
  "replica_set": "rs0",
  "read_preference": "secondaryPreferred",
  "srv": false,
  "database": "your_db",
  "max_threads": 5,
  "backoff_retry_count": 4,
  "chunking_strategy": ""
}
```

**Description of above parameters:**

| Field | Description | Example Value | Data Type |
|-------|-------------|---------------|-----------|
| `hosts` | List of MongoDB hosts. Use DNS SRV if `srv = true`. | `x.xxx.xxx.120:27017`, `x.xxx.xxx.120:27017`, `x.xxx.xxx.133:27017` (can be multiple) | STRING[] |
| `username`/`password` | Credentials for MongoDB authentication. | `"test"`/`"test"` | STRING |
| `authdb` | Authentication database (often `admin`). | `"admin"` | STRING |
| `replica_set` | Name of the replica set, if applicable. | `"rs0"` | STRING |
| `read_preference` | Which node to read from (e.g., `secondaryPreferred`). | `"secondaryPreferred"` | STRING |
| `srv` | If `true`, the `hosts` key will have a value something like `["mongodatatest.pigiy.mongodb.net"]` | `true`/ `false` | BOOL |
| `database` | The MongoDB database name to replicate. | `"database_name"` | STRING |
| `max_threads` | Maximum parallel threads for chunk-based snapshotting. | `5` | INT |
| `backoff_retry_count` | Retries attempt to establish sync again if it fails, increases exponentially (in minutes - 1, 2, 4, 8, 16... depending upon the `backoff_retry_count` value) | defaults to 3, takes default value if set to -1 | INT |
| `chunking_strategy` | The chunking strategy used for backfill. <br/>- `timestamp`: Splits data based on time fields.<br/>- `bucket_auto`: Uses MongoDB’s `$bucketAuto` for automatic bucketing.<br/>- `splitVector`: Uses the built-in `splitVector` command. <br/>If left empty, defaults to `splitVector`. <br/>Refer [here](../../../blog/2025-05-07-what-makes-olake-fast#mongodb) for more details. | `"timestamp"` / `"bucket_auto"` / `"splitVector"` | STRING |

#### 3) Run Discover Command

The Discover command generates json content for `streams.json` file, which defines the schema of the collections to be synced.

<Tabs>

  <TabItem value="olake_docker" label="OLake Docker" default>

```bash
docker run --pull=always \
  -v "$HOME/PATH_TO_OLAKE_DIRECTORY:/mnt/config" \
  olakego/source-mongodb:latest \
  discover \
  --config /mnt/config/source.json
```

</TabItem>

<TabItem value="using_binary_file" label="Using Binary File">

```bash
[PATH_TO_MONGODB_BINARY_FILE]/olake check --config [PATH_TO_CONFIG_FOLDER]/source.json
```

</TabItem>

</Tabs>

<StreamsConfiguration/>

#### 4) Running the Sync

Once `source.json`, `streams.json`, and `destination.json` are ready, you can run the sync jobs.

ℹ️ **Note:** Instructions for creating the `destination.json` file are provided in the MongoDB Destination Document. Link to this document is provided [here](../../core/configs/writer.mdx)

The Sync command fetches data from MongoDB and ingests it into the specified destination (e.g., Iceberg on MinIO/S3).

##### 1. Full Data Sync (No State Tracking)

This will ingest the entire dataset each time (no CDC or checkpointing).

```bash
docker run --pull=always \
  -v "$HOME/PATH_TO_OLAKE_DIRECTORY:/mnt/config" \
  olakego/source-mongodb:latest \
  sync \
  --config /mnt/config/source.json \
  --catalog /mnt/config/streams.json \
  --destination /mnt/config/destination.json
```

##### 2. Incremental / CDC Sync (With State Tracking)

This mode enables change data capture (CDC) or incremental syncs using a checkpoint file (`state.json`).

It only syncs new/updated records since the last run.

```bash
docker run --pull=always \
  -v "$HOME/PATH_TO_OLAKE_DIRECTORY:/mnt/config" \
  olakego/source-mongodb:latest \
  sync \
  --config /mnt/config/source.json \
  --catalog /mnt/config/streams.json \
  --destination /mnt/config/destination.json \
  --state /mnt/config/state.json
```

</TabItem>

</Tabs>

---

### MongoDB to Iceberg Data Type Mapping

| MongoDB Data Types | Iceberg Data Type |
|--------------------|-------------------|
| - int<br/>-timestamp | int |
| long | bigint |
| None Observed | float |
| double | double |
| boolean | boolean |
| date | timestamp |
| -string<br/>-object<br/>-objectId<br/>-binData (binary)<br/>-code<br/>-regex (BSONRegExp)<br/>-decimal128<br/>-maxKey<br/>-minKey<br/>-array<br/>-undefined | string |

---

## Troubleshooting

| Issue | Possible Cause | Solution |
|-------|----------------|----------|
| Connection failed (UI/CLI) | Wrong host/port, Mongo not running | Check MongoDB is up and accessible. |
| CDC not working (UI/CLI) | Mongo not in replica set / oplog not accessible | Verify replica set is active by running `rs.status()` |
| File not found (CLI) | Not in correct directory while running commands | Make sure both `source.json` and `destination.json` are present in correct directory and the commands are executed while inside the directory. |

